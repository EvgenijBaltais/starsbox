import{getFinalPrice,getFinalPriceDecorated,countProductsAmount,countFinalSumm,emptyCartInfo,returnCorrectWord,make_array,findParent,plusToCart,minusToCart,returnCartValues}from"./functions.min.js";document.addEventListener("DOMContentLoaded",()=>{localStorage.getItem("order")||setTimeout(()=>{emptyCartInfo()},500),(()=>{if(!localStorage.getItem("order"))return!1;let e=JSON.parse(localStorage.getItem("order")),t=0,r=0,a=[];fetch("/php/cart_data.php",{method:"POST",headers:{"Content-type":"application/x-www-form-urlencoded; charset=UTF-8"},body:JSON.stringify({order:e})}).then(e=>e.text()).then(n=>{a=(a=JSON.parse(n)).data;for(let t in e)a.forEach(r=>{+e[t].id==+r.id&&(r.amount=+e[t].amount)});a.forEach(e=>{t+=e.price,r+=getFinalPrice(e.price,e.sale)*e.amount}),setTimeout(()=>{document.querySelector(".cart-preloader").remove(),document.querySelector(".cart-section").insertAdjacentHTML("beforeend",'\n                    <div class="cart-wrapper-w"><div class="cart-wrapper"></div><div class="cart-final"></div></div>\n                    '),a.forEach(e=>{document.querySelector(".cart-wrapper").insertAdjacentHTML("beforeend",`\n\n                        <div class = "cart-item" data-id = "${e.id}">\n                        <div class = "cart-remove" data-id = ${e.id} title = "Удалить товар из корзины"></div>\n                        <div class="product-cart-pic">\n                        <a href = "/catalog/${e.url_name}" target = "_blank" class = "product-cart-pic-link">\n                        <img src="/images/catalog/brands/${e.id}/1_s.png" alt="" class = "product-cart-pic-img">\n                        </a>\n                        </div>\n                        <div class = "product-cart-content">\n                        <div class="product-cart-title">\n                        <a href = "/catalog/${e.url_name}" target = "_blank" class = "product-cart-title-link thin-font-style">\n                        <span class = "product-cart-title-span">${e.category}</span> <span class = "product-cart-title-span bold-text-600">${e.brand} ${e.name}, <span class = "product-cart-item-weight">${e.weight}</span></span>\n                        </a>\n                        </div>\n                        <div class = "cart-in-stock">\n                        <span>В наличии</span>\n                        </div>\n                        <div class="product-cart-bottom">\n                        <div class="product-cart-bottom__left">\n                        <div class = "item-plus-minus">\n                        <div class = "cart-item-amount-minus">–</div>\n                        <div class = "cart-item-amount-val-block">\n                        <label for = "num-${e.id}">\n                        <input type="text" name = "cart-item-amount-value" class = "cart-item-amount-value" readonly = "readonly" value = "${e.amount}" id = "num-${e.id}" aria-label="Количество товаров для заказа">\n                        </label>\n                        </div>\n                        <div class = "cart-item-amount-plus">+</div>\n                        </div>\n                        </div>\n                        <div class="product-cart-bottom__right">\n                        <div class = "product-cart-bottom-div">\n                        ${e.sale>0?`<span class = "product-cart-bottom-full" data-fullprice="${e.price}">${getFinalPriceDecorated(e.price,0,e.amount)} ₽</span>`:""}\n                        <span class = "product-cart-bottom-span" data-price = ${getFinalPrice(e.price,e.sale)}>\n                        ${getFinalPriceDecorated(e.price,e.sale,e.amount)}\n                        </span>\n                        <span class = "product-cart-bottom-span product-cart-bottom-r"> ₽</span>\n                        </div>\n                        </div>\n                        </div>\n                        </div>\n                        </div>\n                        `)}),document.querySelector(".cart-final").insertAdjacentHTML("beforeend",`\n                    <div class = "common-title">\n                    <span class = "common-title-thin">В корзине:</span>\n                    <span class = "common-title-bold">${countProductsAmount(a)} ${returnCorrectWord(countProductsAmount(a))}</span>\n                    </div>\n                    <div class = "cart-all-in-stock">Все товары в наличии</div>\n                    <div class = "cart-common">\n                    <span class = "cart-common-thin">Итого:</span>\n                    <span class = "cart-common-bold final-price" id = "final-price" data-price = "${countFinalSumm(a)}">${countFinalSumm(a).toLocaleString()} ₽</span>\n                    <br><br><span class = ""><i>+ стоимость доставки</i></span>\n                    </div>\n                    <div class="send-order send-order-result">\n                    Оформить заказ\n                    </div>\n                    `)},300)}),document.body.addEventListener("click",()=>{if(event.target.classList.contains("send-order-result")){event.preventDefault();try{ym(95872157,"reachGoal","send_order_result")}catch(e){}if(document.querySelector(".cart-order-ww"))return setTimeout(()=>{document.querySelector(".cart-order-ww").scrollIntoView({behavior:"smooth",block:"start"})},10),!1;document.querySelector(".cart-section").insertAdjacentHTML("beforeend",'\n            <div class = "cart-order-ww">\n            <p class = "h2-title">Почти готово! Осталось только указать данные и оплатить:</p>\n            <div class = "cart-order-register">\n            <form name = "cart-order-register-form" class = "cart-order-register-form">\n            <div class = "cart-order-input-w">\n            <label>\n            <p class = "cart-order-p">Ваше имя (по желанию):</p>\n            <input type = "name" name = "name" class = "cart-order-input" placeholder="Имя">\n            </label>\n            </div>\n            <div class = "cart-order-input-w">\n            <label>\n            <p class = "cart-order-p">Ваш email (по желанию):</p>\n            <input type = "email" name = "email" class = "cart-order-input" placeholder="Email">\n            </label>\n            </div>\n            <div class = "cart-order-input-w">\n            <label>\n            <p class = "cart-order-p">Ваш телефон (для уточнения заказа и доставки):</p>\n            <input type = "phone" name = "phone" class = "cart-order-input required-field" placeholder="+7 (___) ___-__-__">\n            </label>\n            </div>\n            <div class = "cart-order-input-w">\n            <label>\n            <p class = "cart-order-p">Любые комментарии по заказу:</p>\n            <textarea name = "textarea" class = "cart-order-textarea required-field" placeholder="Введите текст"></textarea>\n            <label>\n            </div>\n\n            <div class = "pay-radio pay-radio-1">\n                <div class = "contact-method-form-2">\n                    <p class = "cart-order-p">Как доставить?</p>\n                    <div class = "pay-radio-div">\n                        <label class="contact-label">\n                            <input type="radio" name="radio-1" class = "cart-radio cart-radio-c" checked>\n                            <span>Курьером</span>\n                        </label>\n                    </div>\n                    <div class = "pay-radio-div">\n                        <label class="contact-label">\n                            <input type="radio" name="radio-1" class = "cart-radio cart-radio-p">\n                            <span>В пункт выдачи заказов Яндекс Доставки</span>\n                        </label>\n                    </div>\n                </div>\n            </div>\n\n            <div class = "pay-radio pay-radio-2">\n                <div class = "contact-method-form-2">\n                    <p class = "cart-order-p">Удобнее оплатить:</p>\n                    <div class = "pay-radio-div">\n                        <label class="contact-label">\n                            <input type="radio" name="radio-2" class = "cart-radio cart-radio-1" checked>\n                            <span>Наличными или переводом при получении</span>\n                        </label>\n                    </div>\n                    <div class = "pay-radio-div">\n                        <label class="contact-label">\n                            <input type="radio" name="radio-2" class = "cart-radio cart-radio-2">\n                            <span>Сейчас на сайте</span>\n                        </label>\n                    </div>\n                </div>\n            </div>\n            <div class="agree-block agree-block-final">\n            <label for="checkbox" class="checkbox-label">\n            <input type="checkbox" id="checkbox" class="checkbox" checked>\n            <span class="checkbox-view">\n            <svg class="checkbox-icon" xmlns="http://www.w3.org/2000/svg" width="18" viewBox="0 0 511.985 511.985">\n            <path fill="#000" d="M500.088 83.681c-15.841-15.862-41.564-15.852-57.426 0L184.205 342.148 69.332 227.276c-15.862-15.862-41.574-15.862-57.436 0-15.862 15.862-15.862 41.574 0 57.436l143.585 143.585c7.926 7.926 18.319 11.899 28.713 11.899 10.394 0 20.797-3.963 28.723-11.899l287.171-287.181c15.862-15.851 15.862-41.574 0-57.435z"/>\n            </svg>\n            </span>\n            <span class = "agree-text">Согласен на обработку персональных данных</span>\n            </label>\n            </div>\n            <button class = "cart-form-send btn-10px">Отправить заявку!</button>\n            </form>\n            </div>\n            </div>\n            '),setTimeout(()=>{document.querySelector(".cart-order-ww").scrollIntoView({behavior:"smooth",block:"start"})},10),document.querySelectorAll(".cart-radio").forEach(e=>{e.addEventListener("change",()=>{event.target.classList.contains("cart-radio-1")?document.querySelector(".cart-form-send").innerText="Отправить заявку и оплатить при получении":document.querySelector(".cart-form-send").innerText="Оплатить онлайн"})}),document.querySelectorAll('input[name="radio-1"]').forEach(e=>{e.addEventListener("change",()=>{let e=findParent(event.target,"cart-order-register-form"),t=e.querySelector(".cart-form-send"),r=e.querySelector(".pay-radio-2");if(event.target.classList.contains("cart-radio-p"))return t.innerText="Оплатить онлайн",r.querySelector(".pay-radio-div").insertAdjacentHTML("beforeend",'<div class = "pay-radio-blocked"></div>'),r.querySelector(".cart-radio-2").checked=!0,!1;t.innerText="Отправить заявку и оплатить при получении",r.querySelector(".pay-radio-blocked").remove(),r.querySelector(".cart-radio-1").checked=!0})}),new Inputmask("+7 (999) 999-99-99").mask(document.querySelector('input[name="phone"]'));let e=0;document.querySelector(".cart-form-send").addEventListener("click",()=>{if(event.preventDefault(),e)return!1;let t=event.target,r=event.target.parentElement,a=r.querySelector('input[name="phone"]'),n=0;if(a.inputmask.isComplete()||(a.parentElement.parentElement.classList.add("input-w-false"),a.parentElement.querySelector(".cart-order-p").innerText="Пожалуйста, введите номер телефона:",a.parentElement.querySelector(".cart-order-p").style.color="red",n++,event.target.innerText="Некорректно введен телефон..."),document.getElementById("checkbox").checked||(document.querySelector(".agree-text").style.color="red",n++),n)return!1;e+=1,t.innerText="Отправка...";let c={};document.querySelectorAll(".cart-item").forEach((e,t)=>{c[t]={},c[t].name=e.querySelector(".product-cart-title-link").innerText,c[t].amount=e.querySelector(".cart-item-amount-value").value,c[t].weight=e.querySelector(".product-cart-item-weight").innerText,c[t].price=e.querySelector(".product-cart-bottom-span").getAttribute("data-price")*c[t].amount}),fetch("/libs/send-cart.php",{method:"POST",body:JSON.stringify({name:r.querySelector('input[name="name"]').value,email:r.querySelector('input[name="email"]').value,phone:a.value,textarea:r.querySelector("textarea").value,payment:r.querySelector('input[name="radio-2"]:checked').parentElement.querySelector("span").innerText,order:localStorage.order,items:c,final_price:document.getElementById("final-price").getAttribute("data-price")}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(e=>{if(!e.ok)throw Error(e.statusText);e.ok&&(t.innerText="Ошибка отправки");try{ym(95872157,"reachGoal","send_cart"),ym(95872157,"reachGoal","cart_form_send")}catch(e){}}).catch(e=>{console.log(e),t.innerText="Ошибка отправки =("})}),document.getElementById("checkbox").addEventListener("change",()=>{document.querySelector(".agree-text").style.color="black"}),document.querySelector(".cart-order-register-form").querySelectorAll('input[name="phone"]').forEach(e=>{e.addEventListener("focus",()=>{event.target.parentElement.parentElement.classList.remove("input-w-false"),event.target.parentElement.querySelector(".cart-order-p").innerText="Ваш телефон (для уточнения заказа и доставки):",event.target.parentElement.querySelector(".cart-order-p").removeAttribute("style"),document.querySelector(".cart-form-send").innerText="Отправить заявку!"}),e.addEventListener("keydown",()=>{event.target.parentElement.parentElement.classList.remove("input-w-false"),event.target.parentElement.querySelector(".cart-order-p").innerText="Ваш телефон (для уточнения заказа и доставки):",event.target.parentElement.querySelector(".cart-order-p").removeAttribute("style"),document.querySelector(".cart-form-send").innerText="Отправить заявку!"})})}let e,t;if(event.target.classList.contains("cart-amount-plus")){if(t=(e=event.target.parentElement.parentElement).querySelector(".cart-amount-span"),parseInt(t.innerText)>=99)return!1;t.innerText=parseInt(t.innerText)+1+" шт.";for(let r=0;r<a.length;r++)+a[r].id==+e.getAttribute("data-id")&&(a[r].amount=parseInt(t.innerText));a.length?localStorage.setItem("order",JSON.stringify(make_array(a))):localStorage.removeItem("order"),a.length&&returnCartValues(),e.querySelector(".cart-summ").innerText=(parseInt(t.innerText)*parseInt(e.querySelector(".cart-price-fullprice").getAttribute("data-fullprice"))).toLocaleString()+" р.",document.getElementById("final-price").innerText=countFinalSumm(a).toLocaleString()+" р.",document.getElementById("final-price").setAttribute("data-price",countFinalSumm(a))}if(event.target.classList.contains("cart-amount-minus")){if(t=(e=event.target.parentElement.parentElement).querySelector(".cart-amount-span"),parseInt(t.innerText)<=1)return!1;t.innerText=parseInt(t.innerText)-1+" шт.";for(let r=0;r<a.length;r++)+a[r].id==+e.getAttribute("data-id")&&(a[r].amount=parseInt(t.innerText));a.length?localStorage.setItem("order",JSON.stringify(make_array(a))):localStorage.removeItem("order"),a.length&&returnCartValues(),e.querySelector(".cart-summ").innerText=(parseInt(t.innerText)*parseInt(e.querySelector(".cart-price-fullprice").getAttribute("data-fullprice"))).toLocaleString()+" р.",document.getElementById("final-price").innerText=countFinalSumm(a).toLocaleString()+" р.",document.getElementById("final-price").setAttribute("data-price",countFinalSumm(a))}if((()=>{if(!document.querySelector(".cart-section"))return!1;if(event.target.classList.contains("cart-item-amount-minus")){let e=findParent(event.target,"cart-item"),t=e.querySelector(".cart-item-amount-value");if(t.value<=1)return!1;t.value=+t.value-1,minusToCart(e.getAttribute("data-id")),returnCartValues(),e.querySelector(".product-cart-bottom-span").innerText=(e.querySelector(".product-cart-bottom-span").getAttribute("data-price")*t.value).toLocaleString(),e.querySelector(".product-cart-bottom-full")&&(e.querySelector(".product-cart-bottom-full").innerText=(e.querySelector(".product-cart-bottom-full").getAttribute("data-fullprice")*t.value).toLocaleString()+" ₽")}if(event.target.classList.contains("cart-item-amount-plus")){let e=findParent(event.target,"cart-item"),t=e.querySelector(".cart-item-amount-value");if(t.value>=99)return!1;t.value=+t.value+1,plusToCart(e.getAttribute("data-id")),returnCartValues(),e.querySelector(".product-cart-bottom-span").innerText=(e.querySelector(".product-cart-bottom-span").getAttribute("data-price")*t.value).toLocaleString(),e.querySelector(".product-cart-bottom-full")&&(e.querySelector(".product-cart-bottom-full").innerText=(e.querySelector(".product-cart-bottom-full").getAttribute("data-fullprice")*t.value).toLocaleString()+" ₽")}})(),event.target.classList.contains("cart-remove")){let e=JSON.parse(localStorage.getItem("order"));for(let t=0;t<e.length;t++)e[t].id==event.target.getAttribute("data-id")&&e.splice(t,1);if(e.length?localStorage.setItem("order",JSON.stringify(make_array(e))):localStorage.removeItem("order"),e.length&&returnCartValues(),event.target.parentElement.remove(),document.querySelectorAll(".cart-item").length)return!1;emptyCartInfo(),returnCartValues(),document.querySelector(".cart-order-ww")&&document.querySelector(".cart-order-ww").remove()}})})()});